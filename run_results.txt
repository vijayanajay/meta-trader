2025-08-22 23:46:44,691 - __main__ - INFO - Application starting.
2025-08-22 23:46:45,152 - orchestrator - INFO - Orchestrator starting run.
2025-08-22 23:46:45,152 - orchestrator - INFO - Processing ticker: RELIANCE.NS
2025-08-22 23:46:45,152 - orchestrator - INFO - [RELIANCE.NS] Starting optimization loop.
2025-08-22 23:46:45,153 - orchestrator - INFO - [RELIANCE.NS] Loaded state. Current iteration: 1
2025-08-22 23:46:45,222 - orchestrator - INFO - [RELIANCE.NS] Loaded training data: 1970 rows.
2025-08-22 23:46:45,222 - orchestrator - INFO - [RELIANCE.NS] Running Iteration 1/10
2025-08-22 23:46:45,296 - services.llm_service - INFO - Sending prompt to LLM (moonshotai/kimi-k2:free)...
2025-08-22 23:46:47,231 - httpx - INFO - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-08-22 23:46:51,048 - services.llm_service - INFO - LLM usage: Prompt tokens: 656, Completion tokens: 119
2025-08-22 23:46:51,051 - orchestrator - ERROR - A critical error occurred during the run for ticker RELIANCE.NS. Aborting process for this ticker.
Traceback (most recent call last):
  File "D:\Code\meta-trader\src\orchestrator.py", line 78, in run
    self._run_for_ticker(ticker)
  File "D:\Code\meta-trader\src\orchestrator.py", line 172, in _run_for_ticker
    self.state_manager.save_state(ticker, run_state)
  File "D:\Code\meta-trader\src\services\state_manager.py", line 59, in save_state
    raise e
  File "D:\Code\meta-trader\src\services\state_manager.py", line 55, in save_state
    temp_path.rename(state_filepath)
  File "C:\Users\user\AppData\Local\Programs\Python\Python312\Lib\pathlib.py", line 1363, in rename
    os.rename(self, target)
FileExistsError: [WinError 183] Cannot create a file when that file already exists: 'D:\\Code\\meta-trader\\results\\tmp41nizow3.tmp' -> 'results\\RELIANCE.NS_run_state.json'
2025-08-22 23:46:51,053 - orchestrator - INFO - Processing ticker: TCS.NS
2025-08-22 23:46:51,053 - orchestrator - INFO - [TCS.NS] Starting optimization loop.
2025-08-22 23:46:51,054 - orchestrator - INFO - [TCS.NS] Loaded state. Current iteration: 1
2025-08-22 23:46:51,059 - orchestrator - INFO - [TCS.NS] Loaded training data: 1970 rows.
2025-08-22 23:46:51,059 - orchestrator - INFO - [TCS.NS] Running Iteration 1/10
2025-08-22 23:46:51,114 - services.llm_service - INFO - Sending prompt to LLM (moonshotai/kimi-k2:free)...
2025-08-22 23:46:52,698 - httpx - INFO - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-08-22 23:46:55,140 - services.llm_service - INFO - LLM usage: Prompt tokens: 673, Completion tokens: 105
2025-08-22 23:46:55,143 - orchestrator - ERROR - A critical error occurred during the run for ticker TCS.NS. Aborting process for this ticker.
Traceback (most recent call last):
  File "D:\Code\meta-trader\src\orchestrator.py", line 78, in run
    self._run_for_ticker(ticker)
  File "D:\Code\meta-trader\src\orchestrator.py", line 172, in _run_for_ticker
    self.state_manager.save_state(ticker, run_state)
  File "D:\Code\meta-trader\src\services\state_manager.py", line 59, in save_state
    raise e
  File "D:\Code\meta-trader\src\services\state_manager.py", line 55, in save_state
    temp_path.rename(state_filepath)
  File "C:\Users\user\AppData\Local\Programs\Python\Python312\Lib\pathlib.py", line 1363, in rename
    os.rename(self, target)
FileExistsError: [WinError 183] Cannot create a file when that file already exists: 'D:\\Code\\meta-trader\\results\\tmp26d0wd2m.tmp' -> 'results\\TCS.NS_run_state.json'
2025-08-22 23:46:55,144 - orchestrator - INFO - Processing ticker: HDFCBANK.NS
2025-08-22 23:46:55,144 - orchestrator - INFO - [HDFCBANK.NS] Starting optimization loop.
2025-08-22 23:46:55,146 - orchestrator - INFO - [HDFCBANK.NS] Loaded state. Current iteration: 1
2025-08-22 23:46:55,152 - orchestrator - INFO - [HDFCBANK.NS] Loaded training data: 1970 rows.
2025-08-22 23:46:55,152 - orchestrator - INFO - [HDFCBANK.NS] Running Iteration 1/10
2025-08-22 23:46:55,162 - orchestrator - ERROR - [HDFCBANK.NS] Backtest failed for iteration 1: Invalid expression 'ema_fast > ema_slow and rsi > 55 and adx > 25': Name 'adx' is not defined in the strategy context.
Traceback (most recent call last):
  File "D:\Code\meta-trader\src\services\strategy_engine.py", line 44, in _validate_expression
    raise NameError(f"Name '{name}' is not defined in the strategy context.")
NameError: Name 'adx' is not defined in the strategy context.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "D:\Code\meta-trader\src\orchestrator.py", line 122, in _run_for_ticker
    strategy_class = self.strategy_engine.process(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "D:\Code\meta-trader\src\services\strategy_engine.py", line 128, in process
    self._validate_expression(strategy_def.buy_condition, available_names)
  File "D:\Code\meta-trader\src\services\strategy_engine.py", line 46, in _validate_expression
    raise ValueError(f"Invalid expression '{expression}': {e}") from e
ValueError: Invalid expression 'ema_fast > ema_slow and rsi > 55 and adx > 25': Name 'adx' is not defined in the strategy context.
2025-08-22 23:46:55,164 - orchestrator - ERROR - Creating failure report for strategy: EMA_RSI_ADX_Trend_Filter
2025-08-22 23:46:55,164 - services.llm_service - INFO - Sending prompt to LLM (moonshotai/kimi-k2:free)...
2025-08-22 23:46:56,854 - httpx - INFO - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-08-22 23:47:00,358 - services.llm_service - INFO - LLM usage: Prompt tokens: 895, Completion tokens: 145
2025-08-22 23:47:00,360 - orchestrator - ERROR - A critical error occurred during the run for ticker HDFCBANK.NS. Aborting process for this ticker.
Traceback (most recent call last):
  File "D:\Code\meta-trader\src\orchestrator.py", line 78, in run
    self._run_for_ticker(ticker)
  File "D:\Code\meta-trader\src\orchestrator.py", line 172, in _run_for_ticker
    self.state_manager.save_state(ticker, run_state)
  File "D:\Code\meta-trader\src\services\state_manager.py", line 59, in save_state
    raise e
  File "D:\Code\meta-trader\src\services\state_manager.py", line 55, in save_state
    temp_path.rename(state_filepath)
  File "C:\Users\user\AppData\Local\Programs\Python\Python312\Lib\pathlib.py", line 1363, in rename
    os.rename(self, target)
FileExistsError: [WinError 183] Cannot create a file when that file already exists: 'D:\\Code\\meta-trader\\results\\tmp7kdkikux.tmp' -> 'results\\HDFCBANK.NS_run_state.json'
2025-08-22 23:47:00,361 - orchestrator - INFO - Orchestrator run finished.
2025-08-22 23:47:00,361 - __main__ - INFO - Application finished successfully.
